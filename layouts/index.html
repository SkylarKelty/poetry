{{ define "main" }}
  {{ $poems := where .Site.RegularPages "Section" "poems" }}
  {{ $poems = sort $poems "Date" "desc" }}
  {{ $cats := .Site.Taxonomies.categories }}
  {{ if not $cats }}{{ $cats = .Site.Taxonomies.category }}{{ end }}
  {{ $scratch := newScratch }}
  {{ $scratch.Set "featured" nil }}
  {{ range $poems }}
    {{ if and (not ($scratch.Get "featured")) .Params.featured }}
      {{ $scratch.Set "featured" . }}
    {{ end }}
  {{ end }}
  {{ if and (not ($scratch.Get "featured")) (gt (len $poems) 0) }}
    {{ $scratch.Set "featured" (index $poems 0) }}
  {{ end }}
  {{ $featured := $scratch.Get "featured" }}
  <section class="home-intro">
    <h1>Verses for the hours between light and dark</h1>
    <p>
      {{ len $poems }} poems
      {{ if gt (len $cats) 0 }}across {{ len $cats }} categories{{ end }}.
      A quiet archive of moonlit lines.
    </p>
  </section>

  <section class="poem-list-head">
    <h1>Recent Poems</h1>
    <p>{{ len $poems }} {{ if eq (len $poems) 1 }}poem{{ else }}poems{{ end }} total</p>
  </section>
  <section class="poem-grid home-poem-grid">
    {{ $shown := 0 }}
    {{ range $poem := $poems }}
      {{ if and $featured (eq $poem.RelPermalink $featured.RelPermalink) }}
      {{ else }}
        {{ if lt $shown 6 }}
          <article class="poem-card" style="animation-delay: {{ mul $shown 90 }}ms;">
            <a href="{{ $poem.RelPermalink }}" class="poem-card-link">
              <div class="poem-card-top">
                <h2>{{ $poem.Title }}</h2>
                <span>
                {{ $cat := "" }}
                {{ with $poem.Params.categories }}{{ $cat = index . 0 }}{{ else }}{{ with $poem.Params.category }}{{ $cat = . }}{{ end }}{{ end }}
                {{ $cat }}
                </span>
              </div>
              <p>{{ if $poem.Summary }}{{ $poem.Summary | plainify | truncate 150 }}{{ else }}{{ $poem.Plain | truncate 150 }}{{ end }}</p>
              <time>{{ $poem.Date.Format "2 January 2006" }}</time>
            </a>
          </article>
          {{ $shown = add $shown 1 }}
        {{ end }}
      {{ end }}
    {{ end }}
  </section>
{{ end }}
